<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Groups Map | Barabbas Road Church</title>
  <meta name="description" content="Find a Life Group near you. Weekly small groups throughout San Diego for fellowship, Bible study, and community.">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    :root {
      --charcoal: #272727;
      --gold: #C0A365;
      --teal: #279AB3;
      --white: #ffffff;
      --light-gray: #f5f5f5;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: var(--light-gray);
      color: var(--charcoal);
      line-height: 1.6;
    }
    
    /* Header */
    .header {
      background: var(--charcoal);
      color: var(--white);
      padding: 2rem;
      text-align: center;
    }
    
    .header h1 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 700;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: var(--gold);
      letter-spacing: 0.02em;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Filter Section */
    .filter-section {
      background: var(--white);
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .filter-container {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      align-items: center;
    }
    
    .filter-label {
      font-weight: 600;
      color: var(--charcoal);
      margin-right: 0.5rem;
    }
    
    .filter-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--charcoal);
      background: var(--white);
      color: var(--charcoal);
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 500;
      font-size: 1rem;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 48px; /* Touch-friendly minimum */
    }
    
    .filter-btn:hover {
      background: var(--light-gray);
    }
    
    .filter-btn.active {
      background: var(--gold);
      border-color: var(--gold);
      color: var(--charcoal);
    }
    
    .filter-btn.active[data-day="Sunday"] { background: #C0A365; border-color: #C0A365; }
    .filter-btn.active[data-day="Monday"] { background: #279AB3; border-color: #279AB3; color: white; }
    .filter-btn.active[data-day="Wednesday"] { background: #6B8E23; border-color: #6B8E23; color: white; }
    .filter-btn.active[data-day="Thursday"] { background: #8B4513; border-color: #8B4513; color: white; }
    
    /* Larger touch targets on tablet */
    @media (min-width: 768px) and (max-width: 1100px) {
      .filter-btn {
        padding: 0.85rem 1.75rem;
        font-size: 1.05rem;
      }
    }
    
    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      max-width: 1400px;
      margin: 0 auto;
      gap: 0;
      min-height: calc(100vh - 200px);
    }
    
    @media (max-width: 1100px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    /* Map */
    #map {
      height: 600px;
      width: 100%;
      min-height: 500px;
    }
    
    /* iPad optimizations */
    @media (min-width: 768px) and (max-width: 1100px) {
      #map {
        height: 55vh;
        min-height: 450px;
      }
    }
    
    /* iPad landscape */
    @media (min-width: 1024px) and (max-height: 900px) and (orientation: landscape) {
      .main-content {
        grid-template-columns: 1fr 380px;
      }
      #map {
        height: calc(100vh - 180px);
      }
      .sidebar {
        max-height: calc(100vh - 180px);
      }
    }
    
    @media (max-width: 767px) {
      #map {
        height: 350px;
      }
    }
    
    /* Sidebar */
    .sidebar {
      background: var(--white);
      padding: 2rem;
      overflow-y: auto;
      max-height: 600px;
    }
    
    @media (max-width: 1100px) {
      .sidebar {
        max-height: none;
        padding: 1.5rem;
      }
    }
    
    .sidebar h2 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 500;
      color: var(--charcoal);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }
    
    /* Group Cards */
    .group-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .group-card {
      background: var(--light-gray);
      border-radius: 8px;
      padding: 1.1rem 1.25rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid var(--gold);
      min-height: 80px;
    }
    
    .group-card:hover,
    .group-card:active {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* iPad card sizing */
    @media (min-width: 768px) and (max-width: 1100px) {
      .group-card {
        padding: 1.25rem 1.5rem;
      }
      .group-list {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
    }
    
    .group-card.hidden {
      display: none;
    }
    
    .group-card.full {
      opacity: 0.6;
      border-left-color: #999;
    }
    
    .group-card {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .group-card .leader-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid var(--gold);
    }
    
    .group-card .card-content {
      flex: 1;
      min-width: 0;
    }
    
    .group-card h3 {
      font-size: 1rem;
      color: var(--charcoal);
      margin-bottom: 0.25rem;
    }
    
    .group-card .details {
      font-size: 0.9rem;
      color: #666;
    }
    
    .group-card .day-badge {
      display: inline-block;
      color: white;
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      margin-top: 0.5rem;
    }
    
    .group-card .day-badge.day-sunday { background: #C0A365; }
    .group-card .day-badge.day-monday { background: #279AB3; }
    .group-card .day-badge.day-wednesday { background: #6B8E23; }
    .group-card .day-badge.day-thursday { background: #8B4513; }
    
    .group-card .full-badge {
      background: #dc3545;
      color: white;
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      margin-left: 0.5rem;
    }
    
    .group-card .join-btn {
      background: var(--gold);
      color: var(--charcoal);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.5rem;
      transition: all 0.2s ease;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    .group-card .join-btn:hover {
      background: #d4b578;
    }
    
    .group-card.full .join-btn {
      display: none;
    }
    
    .group-card .note {
      font-size: 0.8rem;
      color: var(--teal);
      font-style: italic;
      margin-top: 0.25rem;
    }
    
    /* Signup Form */
    .signup-section {
      background: var(--charcoal);
      color: var(--white);
      padding: 3rem 2rem;
    }
    
    .signup-container {
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }
    
    .signup-section h2 {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-weight: 300;
      color: var(--gold);
      margin-bottom: 0.5rem;
      font-size: 2rem;
      letter-spacing: 0.02em;
    }
    
    .signup-section p {
      margin-bottom: 1.5rem;
      opacity: 0.9;
    }
    
    .signup-form {
      display: grid;
      gap: 1rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      text-align: left;
    }
    
    .form-group label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    
    .form-group select {
      cursor: pointer;
    }
    
    .submit-btn {
      background: var(--gold);
      color: var(--charcoal);
      border: none;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin-top: 0.5rem;
    }
    
    .submit-btn:hover {
      background: #d4b578;
      transform: translateY(-2px);
    }
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      padding: 1rem;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      max-width: 450px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px) scale(0.95);
      transition: all 0.3s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-overlay.active .modal {
      transform: translateY(0) scale(1);
    }
    
    .modal-header {
      background: var(--charcoal);
      color: white;
      padding: 1.5rem;
      text-align: center;
      border-radius: 16px 16px 0 0;
    }
    
    .modal-header img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--gold);
      margin-bottom: 0.75rem;
    }
    
    .modal-header h3 {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .modal-header .modal-group-details {
      opacity: 0.9;
      font-size: 0.95rem;
    }
    
    .modal-header .modal-day-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 0.5rem;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-body p {
      text-align: center;
      color: #666;
      margin-bottom: 1.25rem;
      font-size: 0.95rem;
    }
    
    .modal-form .form-group {
      margin-bottom: 1rem;
    }
    
    .modal-form label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.35rem;
      color: var(--charcoal);
      font-size: 0.9rem;
    }
    
    .modal-form input {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      transition: border-color 0.2s ease;
    }
    
    .modal-form input:focus {
      outline: none;
      border-color: var(--gold);
    }
    
    .modal-form .submit-btn {
      width: 100%;
      background: var(--gold);
      color: var(--charcoal);
      border: none;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin-top: 0.5rem;
    }
    
    .modal-form .submit-btn:hover {
      background: #d4b578;
      transform: translateY(-2px);
    }
    
    .modal-form .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .modal-header {
      position: relative;
    }
    
    /* Success state */
    .modal-success {
      text-align: center;
      padding: 2rem 1.5rem;
    }
    
    .modal-success .checkmark {
      width: 70px;
      height: 70px;
      background: #4CAF50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 2rem;
      color: white;
    }
    
    .modal-success h3 {
      font-size: 1.5rem;
      color: var(--charcoal);
      margin-bottom: 0.5rem;
    }
    
    .modal-success p {
      color: #666;
      margin-bottom: 1.5rem;
    }
    
    .modal-success .close-btn {
      background: var(--charcoal);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* Popup Styles */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
    }
    
    .leaflet-popup-content {
      margin: 12px 16px;
    }
    
    .popup-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: var(--charcoal);
    }
    
    .popup-details {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Footer */
    .footer {
      background: var(--charcoal);
      color: var(--white);
      text-align: center;
      padding: 1.5rem;
      font-size: 0.9rem;
    }
    
    .footer a {
      color: var(--gold);
      text-decoration: none;
    }
    
    /* No results message */
    .no-results {
      text-align: center;
      padding: 2rem;
      color: #666;
      display: none;
    }
    
    .no-results.visible {
      display: block;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Life Groups</h1>
    <p>Find community, grow in faith, and build lasting friendships. Life Groups meet weekly throughout San Diego.</p>
  </header>
  
  <section class="filter-section">
    <div class="filter-container">
      <span class="filter-label">Filter by Day:</span>
      <button class="filter-btn active" data-day="all">All Days</button>
      <button class="filter-btn" data-day="Sunday">Sunday</button>
      <button class="filter-btn" data-day="Monday">Monday</button>
      <button class="filter-btn" data-day="Wednesday">Wednesday</button>
      <button class="filter-btn" data-day="Thursday">Thursday</button>
    </div>
  </section>
  
  <main class="main-content">
    <div id="map"></div>
    
    <aside class="sidebar">
      <h2>Groups (<span id="group-count">18</span>)</h2>
      <div class="group-list" id="group-list">
        <!-- Group cards populated by JS -->
      </div>
      <div class="no-results" id="no-results">
        No groups meet on this day. Try selecting a different day.
      </div>
    </aside>
  </main>
  
  <section class="signup-section">
    <div class="signup-container">
      <h2>Find Your Community</h2>
      <p>Browse the groups above and click <strong>"Join Group"</strong> on any group that fits your schedule. We'll connect you with the leader!</p>
      <p style="margin-top: 1rem; opacity: 0.8;">Questions? Call us at <a href="tel:619-289-8987" style="color: var(--gold);">619.289.8987</a> or visit on Sunday morning.</p>
    </div>
  </section>
  
  <!-- Signup Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-header" id="modal-header">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <img id="modal-image" src="" alt="">
        <h3 id="modal-name"></h3>
        <div class="modal-group-details" id="modal-details"></div>
        <span class="modal-day-badge" id="modal-badge"></span>
      </div>
      <div class="modal-body" id="modal-body">
        <p>Fill out the form below and we'll connect you with this group!</p>
        <form class="modal-form" id="modal-form">
          <input type="hidden" id="modal-group-id" name="group">
          <div class="form-group">
            <label for="modal-name-input">Your Name *</label>
            <input type="text" id="modal-name-input" name="name" required placeholder="First and Last Name">
          </div>
          <div class="form-group">
            <label for="modal-email">Email *</label>
            <input type="email" id="modal-email" name="email" required placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="modal-phone">Phone</label>
            <input type="tel" id="modal-phone" name="phone" placeholder="(619) 555-1234">
          </div>
          <button type="submit" class="submit-btn" id="modal-submit">Join This Group</button>
        </form>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2026 <a href="https://www.barabbas.com">Barabbas Road Church</a> ¬∑ 7340 Miramar Rd, San Diego, CA ¬∑ 619.289.8987</p>
  </footer>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // Group data with coordinates and leader photos
    const groups = [
      { id: 1, name: "Brett & Kari's Group", day: "Sunday", time: "12:30pm", location: "Church Campus", lat: 32.8754, lng: -117.1425, full: true, image: "https://www.barabbas.com/wp-content/uploads/2015/05/brettkari3.jpg" },
      { id: 2, name: "Jesse's Group", day: "Sunday", time: "1:00pm", location: "Scripps Ranch", lat: 32.9000, lng: -117.1000, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/jesse.png" },
      { id: 3, name: "Justin's Group", day: "Sunday", time: "2:00pm", location: "Lemon Grove", lat: 32.7425, lng: -117.0314, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/justin.png" },
      { id: 4, name: "Jeremy's Group", day: "Sunday", time: "6:00pm", location: "Coronado", lat: 32.6859, lng: -117.1831, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/jeremy1.png" },
      { id: 5, name: "Jon Paul's Group", day: "Sunday", time: "6:00pm", location: "Scripps Ranch", lat: 32.9050, lng: -117.1050, full: true, image: "https://www.barabbas.com/wp-content/uploads/2015/05/jonpaul.jpg" },
      { id: 6, name: "Mark's Group", day: "Monday", time: "6:00pm", location: "Cardiff", lat: 33.0214, lng: -117.2766, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/mark.png" },
      { id: 7, name: "Brett's Group", day: "Monday", time: "6:30pm", location: "Bay Park", lat: 32.7905, lng: -117.2120, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/brett2.png" },
      { id: 8, name: "Jon's Group", day: "Monday", time: "6:30pm", location: "Crown Point/PB", lat: 32.7874, lng: -117.2360, full: false, note: "2nd & 4th Monday", image: "https://www.barabbas.com/wp-content/uploads/2015/05/jon.png" },
      { id: 9, name: "Rob's Group", day: "Wednesday", time: "5:00pm", location: "Rancho Pe√±asquitos", lat: 32.9595, lng: -117.1128, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/rob.jpg" },
      { id: 10, name: "Justin's Group", day: "Wednesday", time: "6:00pm", location: "Ministry Center", lat: 32.8760, lng: -117.1430, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/justin2.png" },
      { id: 11, name: "Connor's Group", day: "Wednesday", time: "6:30pm", location: "Santee", lat: 32.8384, lng: -116.9739, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/connor.png" },
      { id: 12, name: "Beau's Group", day: "Wednesday", time: "6:30pm", location: "University City", lat: 32.8660, lng: -117.2100, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/beau2.png" },
      { id: 13, name: "Garrett's Group", day: "Wednesday", time: "6:00pm", location: "La Mesa", lat: 32.7678, lng: -117.0231, full: true, image: "https://www.barabbas.com/wp-content/uploads/2015/05/garrett.png" },
      { id: 14, name: "Adriana's Group", day: "Thursday", time: "9:30am", location: "Clairemont", lat: 32.8370, lng: -117.2000, full: false, note: "Women's Only", image: "https://www.barabbas.com/wp-content/uploads/2015/05/adriana.png" },
      { id: 15, name: "Tyler's Group", day: "Thursday", time: "6:00pm", location: "Church Campus", lat: 32.8754, lng: -117.1425, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/tyler.jpg" },
      { id: 16, name: "Robert's Group", day: "Thursday", time: "6:30pm", location: "Del Cerro / SDSU", lat: 32.7700, lng: -117.0600, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/robert.png" },
      { id: 17, name: "Brandon's Group", day: "Thursday", time: "6:30pm", location: "El Cajon", lat: 32.7948, lng: -116.9625, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/brandon.jpg" },
      { id: 18, name: "Jim's Group", day: "Thursday", time: "7:00pm", location: "Clairemont", lat: 32.8420, lng: -117.1950, full: false, image: "https://www.barabbas.com/wp-content/uploads/2015/05/jim1.png" }
    ];
    
    // Day colors
    const dayColors = {
      Sunday: '#C0A365',
      Monday: '#279AB3',
      Wednesday: '#6B8E23',
      Thursday: '#8B4513'
    };
    
    // Initialize map centered on San Diego
    const map = L.map('map').setView([32.83, -117.10], 11);
    
    // Add tile layer (CartoDB Voyager - clean with readable labels)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);
    
    // Store markers for filtering
    const markers = [];
    
    // Create custom icon
    function createIcon(day, full) {
      const color = full ? '#999' : dayColors[day];
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          background: ${color};
          width: 28px;
          height: 28px;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14],
        popupAnchor: [0, -14]
      });
    }
    
    // Add markers for each group
    groups.forEach(group => {
      const marker = L.marker([group.lat, group.lng], {
        icon: createIcon(group.day, group.full)
      }).addTo(map);
      
      const fullBadge = group.full ? '<span style="color: #dc3545; font-weight: 600;"> (FULL)</span>' : '';
      const noteText = group.note ? `<br><em style="color: #279AB3;">${group.note}</em>` : '';
      
      marker.bindPopup(`
        <div style="display: flex; align-items: center; gap: 10px;">
          <img src="${group.image}" alt="${group.name}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #C0A365;">
          <div>
            <div class="popup-title">${group.name}${fullBadge}</div>
            <div class="popup-details">
              <strong>${group.day}s</strong> at ${group.time}<br>
              üìç ${group.location}${noteText}
            </div>
          </div>
        </div>
      `);
      
      marker.groupData = group;
      markers.push(marker);
    });
    
    // Render group cards
    function renderGroupCards(filteredGroups) {
      const container = document.getElementById('group-list');
      const noResults = document.getElementById('no-results');
      const countEl = document.getElementById('group-count');
      
      container.innerHTML = '';
      countEl.textContent = filteredGroups.length;
      
      if (filteredGroups.length === 0) {
        noResults.classList.add('visible');
        return;
      }
      
      noResults.classList.remove('visible');
      
      filteredGroups.forEach(group => {
        const card = document.createElement('div');
        card.className = `group-card${group.full ? ' full' : ''}`;
        card.innerHTML = `
          <img src="${group.image}" alt="${group.name}" class="leader-photo" loading="lazy">
          <div class="card-content">
            <h3>${group.name}</h3>
            <div class="details">${group.time} ¬∑ ${group.location}</div>
            ${group.note ? `<div class="note">${group.note}</div>` : ''}
            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
              <span class="day-badge day-${group.day.toLowerCase()}">${group.day}</span>
              ${group.full ? '<span class="full-badge">FULL</span>' : ''}
              ${!group.full ? `<button class="join-btn" data-group-id="${group.id}">Join Group</button>` : ''}
            </div>
          </div>
        `;
        
        // Click card to show on map
        card.querySelector('.leader-photo').addEventListener('click', () => {
          map.setView([group.lat, group.lng], 14);
          const marker = markers.find(m => m.groupData.id === group.id);
          if (marker) marker.openPopup();
        });
        
        card.querySelector('h3').addEventListener('click', () => {
          map.setView([group.lat, group.lng], 14);
          const marker = markers.find(m => m.groupData.id === group.id);
          if (marker) marker.openPopup();
        });
        
        // Join button opens modal
        const joinBtn = card.querySelector('.join-btn');
        if (joinBtn) {
          joinBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openModal(group);
          });
        }
        
        container.appendChild(card);
      });
    }
    
    // Initial render
    renderGroupCards(groups);
    
    // Filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active state
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const day = btn.dataset.day;
        
        // Filter markers
        markers.forEach(marker => {
          if (day === 'all' || marker.groupData.day === day) {
            marker.addTo(map);
          } else {
            marker.remove();
          }
        });
        
        // Filter cards
        const filteredGroups = day === 'all' 
          ? groups 
          : groups.filter(g => g.day === day);
        
        renderGroupCards(filteredGroups);
        
        // Fit map to visible markers
        if (day !== 'all') {
          const visibleMarkers = markers.filter(m => m.groupData.day === day);
          if (visibleMarkers.length > 0) {
            const group = L.featureGroup(visibleMarkers);
            map.fitBounds(group.getBounds().pad(0.2));
          }
        } else {
          map.setView([32.83, -117.10], 11);
        }
      });
    });
    
    // Modal functionality
    const modalOverlay = document.getElementById('modal-overlay');
    let currentGroup = null;
    
    function openModal(group) {
      currentGroup = group;
      
      // Populate modal
      document.getElementById('modal-image').src = group.image;
      document.getElementById('modal-name').textContent = group.name;
      document.getElementById('modal-details').textContent = `${group.day}s at ${group.time} ¬∑ ${group.location}`;
      document.getElementById('modal-group-id').value = `${group.name} (${group.day} ${group.time}, ${group.location})`;
      
      // Set badge color
      const badge = document.getElementById('modal-badge');
      badge.textContent = group.day;
      badge.style.background = dayColors[group.day];
      
      // Reset form
      document.getElementById('modal-form').reset();
      document.getElementById('modal-body').innerHTML = `
        <p>Fill out the form below and we'll connect you with this group!</p>
        <form class="modal-form" id="modal-form">
          <input type="hidden" id="modal-group-id" name="group" value="${group.name} (${group.day} ${group.time}, ${group.location})">
          <div class="form-group">
            <label for="modal-name-input">Your Name *</label>
            <input type="text" id="modal-name-input" name="name" required placeholder="First and Last Name">
          </div>
          <div class="form-group">
            <label for="modal-email">Email *</label>
            <input type="email" id="modal-email" name="email" required placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="modal-phone">Phone</label>
            <input type="tel" id="modal-phone" name="phone" placeholder="(619) 555-1234">
          </div>
          <button type="submit" class="submit-btn" id="modal-submit">Join This Group</button>
        </form>
      `;
      
      // Attach form handler
      document.getElementById('modal-form').addEventListener('submit', handleModalSubmit);
      
      // Show modal
      modalOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      modalOverlay.classList.remove('active');
      document.body.style.overflow = '';
      currentGroup = null;
    }
    
    // Close modal on overlay click
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        closeModal();
      }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
        closeModal();
      }
    });
    
    // Form submission with Formspree
    async function handleModalSubmit(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = form.querySelector('.submit-btn');
      const formData = new FormData(form);
      
      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      
      try {
        // Send to Formspree (replace with your form ID)
        const response = await fetch('https://script.google.com/macros/s/AKfycbxF2U7bDMyeF4dV1895rDW_m08jFNXh8W9Sc4V9xY2mlUp387J57CHrxQrBL7HvgvNz0w/exec', {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          // Show success
          document.getElementById('modal-body').innerHTML = `
            <div class="modal-success">
              <div class="checkmark">‚úì</div>
              <h3>You're In!</h3>
              <p>We've received your request to join ${currentGroup.name}. Someone will be in touch soon!</p>
              <button class="close-btn" onclick="closeModal()">Done</button>
            </div>
          `;
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Join This Group';
        alert('Something went wrong. Please try again or contact the church directly.');
      }
    }
  </script>
</body>
</html>
